# Docker Compose file - version attribute is obsolete in v3.9+

services:
  postgres:
    image: postgres:15-alpine
    container_name: sgp-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-sgp}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-sgp}
      POSTGRES_DB: ${POSTGRES_DB:-sgp}
    ports:
      - "20001:5432"  # PostgreSQL - Host port 20001
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-sgp}"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - sgp-net
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: sgp-redis
    command: >
      sh -c "if [ -n '${REDIS_PASSWORD}' ]; then
        redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes;
      else
        redis-server --appendonly yes;
      fi"
    ports:
      - "20002:6379"  # Redis - Host port 20002
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - sgp-net
    restart: unless-stopped

  user-service:
    build:
      context: ./services/backend-service
      dockerfile: user-service/Dockerfile
    container_name: sgp-user-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-sgp}
      POSTGRES_USER: ${POSTGRES_USER:-sgp}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-sgp}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SERVER_PORT: 8081
    ports:
      - "20003:8081"  # User Service - Host port 20003
    networks:
      - sgp-net
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8081/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    restart: unless-stopped

  order-service:
    build:
      context: ./services/backend-service
      dockerfile: order-service/Dockerfile
    container_name: sgp-order-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-sgp}
      POSTGRES_USER: ${POSTGRES_USER:-sgp}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-sgp}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SERVER_PORT: 8082
    ports:
      - "20004:8082"  # Order Service - Host port 20004
    networks:
      - sgp-net
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8082/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    restart: unless-stopped

  payment-service:
    build:
      context: ./services/backend-service
      dockerfile: payment-service/Dockerfile
    container_name: sgp-payment-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-sgp}
      POSTGRES_USER: ${POSTGRES_USER:-sgp}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-sgp}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SERVER_PORT: 8083
    ports:
      - "20005:8083"  # Payment Service - Host port 20005
    networks:
      - sgp-net
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8083/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    restart: unless-stopped

  analytics:
    build:
      context: ./services/analytics-service
      dockerfile: Dockerfile
    container_name: sgp-analytics
    environment:
      SPRING_PROFILES_ACTIVE: docker
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-sgp}
      POSTGRES_USER: ${POSTGRES_USER:-sgp}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-sgp}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SERVER_PORT: 9000
    ports:
      - "20006:9000"  # Analytics Service - Host port 20006
    networks:
      - sgp-net
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9000/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    restart: unless-stopped

  gateway:
    build:
      context: ./services/gateway
      dockerfile: Dockerfile
    container_name: sgp-gateway
    environment:
      SPRING_PROFILES_ACTIVE: docker
      REDIS_HOST: redis
      REDIS_PORT: 6379
      ANALYTICS_SERVICE_URL: http://analytics:9000/api/v1/telemetry
      SERVER_PORT: 8080
      GATEWAY_RATE_LIMIT_RPM: 1000000
    ports:
      - "20007:8080"  # Gateway - Host port 20007
    networks:
      - sgp-net
    depends_on:
      analytics:
        condition: service_healthy
      redis:
        condition: service_healthy
      user-service:
        condition: service_healthy
      order-service:
        condition: service_healthy
      payment-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    restart: unless-stopped

  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: sgp-dashboard
    ports:
      - "20008:80"  # Dashboard - Host port 20008
    networks:
      - sgp-net
    depends_on:
      analytics:
        condition: service_healthy
    restart: unless-stopped

  traffic-generator:
    build:
      context: ./tools/traffic-generator
      dockerfile: Dockerfile
    container_name: sgp-traffic-generator
    environment:
      GATEWAY_URL: http://gateway:8080
      API_KEY: test-api-key-12345
      MODE: demo
      RPS: 25
      DURATION: 200
      CONCURRENT_USERS: 15
    networks:
      - sgp-net
    depends_on:
      gateway:
        condition: service_healthy
    restart: "no"  # Don't auto-restart - run once for demo

networks:
  sgp-net:
    driver: bridge

volumes:
  redis-data:
  postgres-data:
